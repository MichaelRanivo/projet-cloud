name: CI 

run-name: ${{ github.actor }} is testing out GitHub Actions ðŸš€

on:
  push:
    branches:
      - dev

jobs:
  build-sample-app:
    #utiliser l'os Ubuntut pour le job
    runs-on: self-hosted 
    #Installer PHP8, composer install, crÃ©er un artefact
    steps:
      #Cette ligne nous sert Ã  extraire le repo sur notre workflow  
      - name: Checkout repository
        uses: actions/checkout@v3

      # On ne peut pas utiliser cette faÃ§on de faire car le Github Actions de Epitech est limitÃ©
      # cette ligne nous sert Ã  setup PHP sur notre workflow
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer

      - name: Check the version of PHP 
        run: php --version

      - name: Composer install
        run: |
          cd sample-app/
          composer install
      
      - name: Upload artefact
        uses: actions/upload-artifact@v3
        with:
          name: sample-app-builded
          path: sample-app/

  # test-sample-app:
  #   needs: build-sample-app
  #   #utiliser l'os Ubuntut pour le job
  #   runs-on: ubuntu-20.04 
  #   #Installer PHP8, composer install, crÃ©er un artefact
  #   steps:
  #     #Cette ligne nous sert Ã  extraire le repo sur notre workflow  
  #     - name: Checkout repository
  #       uses: actions/checkout@v3

  #     # On ne peut pas utiliser cette faÃ§on de faire car le Github Actions de Epitech est limitÃ©
  #     # cette ligne nous sert Ã  setup PHP sur notre workflow
  #     # - name: Install PHP
  #     #   uses: shivammathur/setup-php@v2
  #     #   with:
  #     #     php-version: '8.2'

  #     - name: Check the version of PHP 
  #       run: php --version

  #     - uses: actions/download-artifact@v3
  #       with:
  #         name: sample-app-builded
          
  #     - name: Generate key
  #       run: php artisan key:generate

  #     - name: Directory Permissions
  #       run: chmod -R 777 storage bootstrap/cache

  #     - name: Create DB and schemas
  #       run: |
  #         touch database/db.sqlite
          
  #       # php artisan migrate --force

  #     - name: Run the test
  #       env:
  #         DB_CONNECTION: sqlite
  #         DB_DATABASE: database/database.sqlite
  #       run: vendor/bin/phpunit

# test_sample-app:
#   stage: test
#   image: registry.infra.connectwork.fr/expressweb/devops/php8:main
#   script:
#     - cd sample-app/
#     - php artisan migrate:fresh
#     - php artisan db:seed
#     - vendor/bin/phpunit
#   needs:
#     - job: "build_sample-app"
#       artifacts: true

# name: GitHub Actions Demo
# run-name: ${{ github.actor }} is testing out GitHub Actions ðŸš€
# on: [push]
# jobs:
#   Explore-GitHub-Actions:
#     runs-on: ubuntu-latest
#     steps:
#       - run: echo "ðŸŽ‰ The job was automatically triggered by a ${{ github.event_name }} event."
#       - run: echo "ðŸ§ This job is now running on a ${{ runner.os }} server hosted by GitHub!"
#       - run: echo "ðŸ”Ž The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
#       - name: Check out repository code
#         uses: actions/checkout@v3
#       - run: echo "ðŸ’¡ The ${{ github.repository }} repository has been cloned to the runner."
#       - run: echo "ðŸ–¥ï¸ The workflow is now ready to test your code on the runner."
#       - name: List files in the repository
#         run: |
#           ls ${{ github.workspace }}
#       - run: echo "ðŸ This job's status is ${{ job.status }}."


# docker_php_sample-app:
#   stage: package
#   image: "quay.io/buildah/stable:v1.21.0"
#   variables:
#     BUILD_NAME: "sample-app"
#     DOCKER_PATH: ${CI_PROJECT_DIR}/server/images/Dockerfile
#     DOCKER_CONTEXT: ${CI_PROJECT_DIR}/
#     BUILD_VERSION: ${CI_COMMIT_REF_SLUG}
#     BUILD_REGISTRY: ${CI_REGISTRY_IMAGE}
#     FULL_IMAGE_NAME: ${BUILD_REGISTRY}/${BUILD_NAME}:${BUILD_VERSION}
#     DOCKER_OPTIONS: ""
#   script:
#     - buildah login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
#     - buildah login -u "$CI_DEPENDENCY_PROXY_USER" -p "$CI_DEPENDENCY_PROXY_PASSWORD" $CI_DEPENDENCY_PROXY_SERVER
#     - buildah bud --pull ${DOCKER_OPTIONS} -t "$FULL_IMAGE_NAME" -f ${DOCKER_PATH} ${DOCKER_CONTEXT}
#     - buildah push $FULL_IMAGE_NAME
#   needs:
#     - job: "build_sample-app"
#       artifacts: true

# deploy-test:
#   stage: deploy
#   image:
#     name: line/kubectl-kustomize:1.23.6-4.5.4
#     entrypoint: [""]
#   variables:
#     KUBECONFIG: /tmp/kubeconfig
#     GIT_STRATEGY: fetch
#     GIT_SUBMODULE_STRATEGY: none
#     KUBE_CLUSTER: cw-hosting-dev
#     DEPLOY_ENV: dev
#     KUBE_NAMESPACE: epitech
#   before_script:
#     - if [ -z "${KUBECONFIG_DEV}" ]; then echo "The KUBECONFIG_DEV var is unset" && exit 1; else echo ${KUBECONFIG_DEV} | base64 -d > ${KUBECONFIG}; fi
#     - apk add --no-cache gettext libintl
#   script:
#     - kustomize build . | envsubst | kubectl diff -n ${KUBE_NAMESPACE} -f - || true
#     - kustomize build . | envsubst | kubectl apply -n ${KUBE_NAMESPACE} -f -
#   needs: ["docker_php_sample-app"]